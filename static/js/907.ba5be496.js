"use strict";(self.webpackChunkthree_model_viewer=self.webpackChunkthree_model_viewer||[]).push([[907],{7907:function(e,t,r){r.r(t),r.d(t,{Rhino3dmLoader:function(){return o}});var a=r(216);const s=new WeakMap;class o extends a.aNw{constructor(e){super(e),this.libraryPath="",this.libraryPending=null,this.libraryBinary=null,this.libraryConfig={},this.url="",this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig={},this.materials=[],this.warnings=[]}setLibraryPath(e){return this.libraryPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,r,o){var i=new a.hH6(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),this.url=e,i.load(e,(r=>{if(s.has(r))return s.get(r).promise.then(t).catch(o);this.decodeObjects(r,e).then((e=>{e.userData.warnings=this.warnings,t(e)})).catch((e=>o(e)))}),r,o)}debug(){}decodeObjects(e,t){let r,a;var o=e.byteLength;o=this._getWorker(o).then((t=>(r=t,a=this.workerNextTaskID++,new Promise(((t,s)=>{r._callbacks[a]={resolve:t,reject:s},r.postMessage({type:"decode",id:a,buffer:e},[e])}))))).then((e=>this._createGeometry(e.data))).catch((e=>{throw e}));return o.catch((()=>!0)).then((()=>{r&&a&&this._releaseTask(r,a)})),s.set(e,{url:t,promise:o}),o}parse(e,t,r){this.decodeObjects(e,"").then((e=>{e.userData.warnings=this.warnings,t(e)})).catch((e=>r(e)))}_compareMaterials(e){var t={};t.name=e.name,t.color={},t.color.r=e.color.r,t.color.g=e.color.g,t.color.b=e.color.b,t.type=e.type;for(let s=0;s<this.materials.length;s++){var r=this.materials[s],a={};if(a.name=r.name,a.color={},a.color.r=r.color.r,a.color.g=r.color.g,a.color.b=r.color.b,a.type=r.type,JSON.stringify(t)===JSON.stringify(a))return r}return this.materials.push(e),e}_createMaterial(e){if(void 0===e)return new a.Wid({color:new a.Ilk(1,1,1),metalness:.8,name:"default",side:2});var t=e.diffuseColor,r=new a.Ilk(t.r/255,t.g/255,t.b/255),s=(0===t.r&&0===t.g&&0===t.b&&(r.r=1,r.g=1,r.b=1),new a.Wid({color:r,name:e.name,side:2,transparent:0<e.transparency,opacity:1-e.transparency})),o=new a.dpR;for(let l=0;l<e.textures.length;l++){var i=e.textures[l];if(null!==i.image){var n=o.load(i.image);switch(i.type){case"Diffuse":s.map=n;break;case"Bump":s.bumpMap=n;break;case"Transparency":s.alphaMap=n,s.transparent=!0;break;case"Emap":s.envMap=n}n.wrapS=0===i.wrapU?a.rpg:a.uWy,n.wrapT=0===i.wrapV?a.rpg:a.uWy,n.repeat.set(i.repeat[0],i.repeat[1])}}return s}_createGeometry(e){var t=new a.Tme,r=[],s=[],o=[];t.userData.layers=e.layers,t.userData.groups=e.groups,t.userData.settings=e.settings,t.userData.objectType="File3dm",t.userData.materials=null,t.name=this.url;let i=e.objects;var n=e.materials;for(let a=0;a<i.length;a++){var l,c,u=i[a],p=u.attributes;switch(u.objectType){case"InstanceDefinition":s.push(u);break;case"InstanceReference":o.push(u);break;default:let a;void 0!==(a=0<=p.materialIndex?(l=n[p.materialIndex],l=this._createMaterial(l),l=this._compareMaterials(l),this._createObject(u,l)):(l=this._createMaterial(),this._createObject(u,l)))&&(c=e.layers[p.layerIndex],a.visible=!c||e.layers[p.layerIndex].visible,p.isInstanceDefinitionObject?r.push(a):t.add(a))}}for(let b=0;b<s.length;b++){var h=s[b];i=[];for(let e=0;e<h.attributes.objectIds.length;e++){var d=h.attributes.objectIds[e];for(let e=0;e<r.length;e++)d===r[e].userData.attributes.id&&i.push(r[e])}for(let e=0;e<o.length;e++){var y=o[e];if(y.geometry.parentIdefId===h.attributes.id){var g=new a.Tme,m=(y=y.geometry.xform.array,new a.yGw);m.set(y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7],y[8],y[9],y[10],y[11],y[12],y[13],y[14],y[15]),g.applyMatrix4(m);for(let e=0;e<i.length;e++)g.add(i[e].clone(!0));t.add(g)}}}return t.userData.materials=this.materials,t}_createObject(e,t){var r=new a.s4_,s=e.attributes;let o,i,n,l;switch(e.objectType){case"Point":case"PointSet":o=r.parse(e.geometry),i=o.attributes.hasOwnProperty("color")?new a.UY4({vertexColors:!0,sizeAttenuation:!1,size:2}):(n=s.drawColor,l=new a.Ilk(n.r/255,n.g/255,n.b/255),new a.UY4({color:l,sizeAttenuation:!1,size:2})),i=this._compareMaterials(i);var c=new a.woe(o,i);return c.userData.attributes=s,c.userData.objectType=e.objectType,s.name&&(c.name=s.name),c;case"Mesh":case"Extrusion":case"SubD":case"Brep":if(null===e.geometry)return;return(o=r.parse(e.geometry)).attributes.hasOwnProperty("color")&&(t.vertexColors=!0),null===t&&(t=this._createMaterial(),t=this._compareMaterials(t)),c=new a.Kj0(o,t),c.castShadow=s.castsShadows,c.receiveShadow=s.receivesShadows,c.userData.attributes=s,c.userData.objectType=e.objectType,s.name&&(c.name=s.name),c;case"Curve":return o=r.parse(e.geometry),n=s.drawColor,l=new a.Ilk(n.r/255,n.g/255,n.b/255),i=new a.nls({color:l}),i=this._compareMaterials(i),c=new a.x12(o,i),c.userData.attributes=s,c.userData.objectType=e.objectType,s.name&&(c.name=s.name),c;case"TextDot":o=e.geometry;c=document.createElement("canvas").getContext("2d");var u=o.fontHeight+"px "+o.fontFace,p=(c.font=u,c.measureText(o.text).width+10),h=o.fontHeight+10,d=window.devicePixelRatio;d=(c.canvas.width=p*d,c.canvas.height=h*d,c.canvas.style.width=p+"px",c.canvas.style.height=h+"px",c.setTransform(d,0,0,d,0,0),c.font=u,c.textBaseline="middle",c.textAlign="center",l=s.drawColor,c.fillStyle=`rgba(${l.r},${l.g},${l.b},${l.a})`,c.fillRect(0,0,p,h),c.fillStyle="white",c.fillText(o.text,p/2,h/2),new a.ROQ(c.canvas)),u=(d.minFilter=a.wem,d.wrapS=a.uWy,d.wrapT=a.uWy,i=new a.xeV({map:d,depthTest:!1}),new a.jyi(i));return u.position.set(o.point[0],o.point[1],o.point[2]),u.scale.set(p/10,h/10,1),u.userData.attributes=s,u.userData.objectType=e.objectType,s.name&&(u.name=s.name),u;case"Light":let m;switch((o=e.geometry).lightStyle.name){case"LightStyle_WorldPoint":(m=new a.cek).castShadow=s.castsShadows,m.position.set(o.location[0],o.location[1],o.location[2]),m.shadow.normalBias=.1;break;case"LightStyle_WorldSpot":(m=new a.PMe).castShadow=s.castsShadows,m.position.set(o.location[0],o.location[1],o.location[2]),m.target.position.set(o.direction[0],o.direction[1],o.direction[2]),m.angle=o.spotAngleRadians,m.shadow.normalBias=.1;break;case"LightStyle_WorldRectangular":m=new a.T_f;var y=Math.abs(o.width[2]),g=Math.abs(o.length[0]);m.position.set(o.location[0]-g/2,o.location[1],o.location[2]-y/2),m.height=g,m.width=y,m.lookAt(o.direction[0],o.direction[1],o.direction[2]);break;case"LightStyle_WorldDirectional":(m=new a.Ox3).castShadow=s.castsShadows,m.position.set(o.location[0],o.location[1],o.location[2]),m.target.position.set(o.direction[0],o.direction[1],o.direction[2]),m.shadow.normalBias=.1}return m&&(m.intensity=o.intensity,n=o.diffuse,l=new a.Ilk(n.r/255,n.g/255,n.b/255),m.color=l,m.userData.attributes=s,m.userData.objectType=e.objectType),m}}_initLibrary(){if(!this.libraryPending){const r=new a.hH6(this.manager);r.setPath(this.libraryPath);var e=new Promise(((e,t)=>{r.load("rhino3dm.js",e,void 0,t)}));const s=new a.hH6(this.manager);s.setPath(this.libraryPath),s.setResponseType("arraybuffer");var t=new Promise(((e,t)=>{s.load("rhino3dm.wasm",e,void 0,t)}));this.libraryPending=Promise.all([e,t]).then((([e,t])=>{this.libraryConfig.wasmBinary=t,t=function(){let e,t,r,a;function s(e,t){t=new Uint8Array(t);var s=e.File3dm.fromByteArray(t),i=[],n=[],l=[],c=[],u=[],p=[],h=[],d=s.objects(),y=d.count;for(let U=0;U<y;U++){var g=d.get(U),m=function(e,t){var s=e.geometry(),i=e.attributes();let n,l,c,u,p,h=s.objectType;switch(h){case r.ObjectType.Curve:var d=function e(t,a){let s=a,o=[];const i=[];if(t instanceof r.LineCurve)return[t.pointAtStart,t.pointAtEnd];if(t instanceof r.PolylineCurve){s=t.pointCount;for(let e=0;e<s;e++)o.push(t.point(e));return o}if(t instanceof r.PolyCurve){const r=t.segmentCount;for(let a=0;a<r;a++){const r=t.segmentCurve(a),i=e(r,s);o=o.concat(i),r.delete()}return o}if(t instanceof r.ArcCurve&&(s=(s=Math.floor(t.angleDegrees/5))<2?2:s),t instanceof r.NurbsCurve&&1===t.degree){const e=t.tryGetPolyline();for(let t=0;t<e.count;t++)o.push(e.get(t));return e.delete(),o}const n=t.domain,l=s-1;for(let r=0;r<s;r++){const e=n[0]+r/l*(n[1]-n[0]);if(e===n[0]||e===n[1])i.push(e);else{const r=t.tangentAt(e),a=t.tangentAt(i.slice(-1)[0]),s=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],o=a[0]*a[0]+a[1]*a[1]+a[2]*a[2],n=Math.sqrt(s*o);let l;if(0===n)l=Math.PI/2;else{const e=(r.x*a.x+r.y*a.y+r.z*a.z)/n;l=Math.acos(Math.max(-1,Math.min(1,e)))}l<.1||i.push(e)}}return o=i.map((e=>t.pointAt(e))),o}(s,100);c={},l={},u={},c.itemSize=3,c.type="Float32Array",c.array=[];for(let e=0;e<d.length;e++)c.array.push(d[e][0]),c.array.push(d[e][1]),c.array.push(d[e][2]);l.position=c,u.attributes=l,n={data:u};break;case r.ObjectType.Point:var y=s.location,g=(c={},{});y=(l={},u={},c.itemSize=3,c.type="Float32Array",c.array=[y[0],y[1],y[2]],i.drawColor(t));g.itemSize=3,g.type="Float32Array",g.array=[y.r/255,y.g/255,y.b/255],l.position=c,l.color=g,u.attributes=l,n={data:u};break;case r.ObjectType.PointSet:case r.ObjectType.Mesh:n=s.toThreejsJSON();break;case r.ObjectType.Brep:var m=s.faces();p=new r.Mesh;for(let e=0;e<m.count;e++){var b=m.get(e),f=b.getMesh(r.MeshType.Any);f&&(p.append(f),f.delete()),b.delete()}0<p.faces().count&&(p.compact(),n=p.toThreejsJSON(),m.delete()),p.delete();break;case r.ObjectType.Extrusion:(p=s.getMesh(r.MeshType.Any))&&(n=p.toThreejsJSON(),p.delete());break;case r.ObjectType.TextDot:n=o(s);break;case r.ObjectType.Light:"LightStyle_WorldLinear"===(n=o(s)).lightStyle.name&&self.postMessage({type:"warning",id:a,data:{message:`THREE.3DMLoader: No conversion exists for ${h.constructor.name} `+n.lightStyle.name,type:"no conversion",guid:i.id}});break;case r.ObjectType.InstanceReference:(n=o(s)).xform=o(s.xform),n.xform.array=s.xform.toFloatArray(!0);break;case r.ObjectType.SubD:s.subdivide(3),(p=r.Mesh.createFromSubDControlNet(s))&&(n=p.toThreejsJSON(),p.delete());break;default:self.postMessage({type:"warning",id:a,data:{message:"THREE.3DMLoader: Conversion not implemented for "+h.constructor.name,type:"not implemented",guid:i.id}})}if(n)return(l=o(i)).geometry=o(s),0<i.groupCount&&(l.groupIds=i.getGroupList()),0<i.userStringCount&&(l.userStrings=i.getUserStrings()),0<s.userStringCount&&(l.geometry.userStrings=s.getUserStrings()),l.drawColor=i.drawColor(t),h=(h=h.constructor.name).substring(11,h.length),{geometry:n,attributes:l,objectType:h};self.postMessage({type:"warning",id:a,data:{message:`THREE.3DMLoader: ${h.constructor.name} has no associated mesh geometry.`,type:"missing mesh",guid:i.id}})}(g,s);g.delete(),m&&i.push(m)}for(let r=0;r<s.instanceDefinitions().count();r++){var b=s.instanceDefinitions().get(r),f=o(b);f.objectIds=b.getObjectIds(),i.push({geometry:null,attributes:f,objectType:"InstanceDefinition"})}var w=[e.TextureType.Diffuse,e.TextureType.Bump,e.TextureType.Transparency,e.TextureType.Opacity,e.TextureType.Emap],T=[e.TextureType.PBR_BaseColor,e.TextureType.PBR_Subsurface,e.TextureType.PBR_SubsurfaceScattering,e.TextureType.PBR_SubsurfaceScatteringRadius,e.TextureType.PBR_Metallic,e.TextureType.PBR_Specular,e.TextureType.PBR_SpecularTint,e.TextureType.PBR_Roughness,e.TextureType.PBR_Anisotropic,e.TextureType.PBR_Anisotropic_Rotation,e.TextureType.PBR_Sheen,e.TextureType.PBR_SheenTint,e.TextureType.PBR_Clearcoat,e.TextureType.PBR_ClearcoatBump,e.TextureType.PBR_ClearcoatRoughness,e.TextureType.PBR_OpacityIor,e.TextureType.PBR_OpacityRoughness,e.TextureType.PBR_Emission,e.TextureType.PBR_AmbientOcclusion,e.TextureType.PBR_Displacement];for(let r=0;r<s.materials().count();r++){var v=s.materials().get(r),k=v.physicallyBased();let e=o(v);var x=[];for(let t=0;t<w.length;t++){var _=v.getTexture(w[t]);if(_){let e=w[t].constructor.name;var P={type:e=e.substring(12,e.length)},S=s.getEmbeddedFileAsBase64(_.fileName),j=(P.wrapU=_.wrapU,P.wrapV=_.wrapV,P.wrapW=_.wrapW,_.uvwTransform.toFloatArray(!0));P.repeat=[j[0],j[5]],S?P.image="data:image/png;base64,"+S:(self.postMessage({type:"warning",id:a,data:{message:`THREE.3DMLoader: Image for ${e} texture not embedded in file.`,type:"missing resource"}}),P.image=null),x.push(P),_.delete()}}if(e.textures=x,k.supported){for(let e=0;e<T.length;e++){var R=v.getTexture(T[e]);if(R){var M=s.getEmbeddedFileAsBase64(R.fileName);let t=T[e].constructor.name;M={type:t=t.substring(12,t.length),image:"data:image/png;base64,"+M},x.push(M),R.delete()}}var B=o(v.physicallyBased());e=Object.assign(B,e)}n.push(e),v.delete(),k.delete()}for(let r=0;r<s.layers().count();r++){var C=s.layers().get(r),D=o(C);l.push(D),C.delete()}for(let r=0;r<s.views().count();r++){var O=s.views().get(r),L=o(O);c.push(L),O.delete()}for(let r=0;r<s.namedViews().count();r++){var I=s.namedViews().get(r),A=o(I);u.push(A),I.delete()}for(let r=0;r<s.groups().count();r++){var W=s.groups().get(r),E=o(W);p.push(E),W.delete()}t=o(s.settings());var N=s.strings().count();for(let r=0;r<N;r++)h.push(s.strings().get(r));return s.delete(),{objects:i,materials:n,layers:l,views:c,namedViews:u,groups:p,strings:h,settings:t}}function o(e){var t={};for(const a in e){var r=e[a];"function"!=typeof r&&("object"==typeof r&&null!==r&&r.hasOwnProperty("constructor")?t[a]={name:r.constructor.name,value:r.value}:t[a]=r)}return t}onmessage=function(o){const i=o.data;switch(i.type){case"init":const o=(t=i.libraryConfig).wasmBinary;let n;e=new Promise((function(e){n={wasmBinary:o,onRuntimeInitialized:e},rhino3dm(n)})).then((()=>{r=n}));break;case"decode":a=i.id;const l=i.buffer;e.then((()=>{try{var e=s(r,l);self.postMessage({type:"decode",id:i.id,data:e})}catch(e){self.postMessage({type:"error",id:i.id,error:e})}}))}}}.toString(),e=["/* rhino3dm.js */",e,"/* worker */",t.substring(t.indexOf("{")+1,t.lastIndexOf("}"))].join("\n"),this.workerSourceURL=URL.createObjectURL(new Blob([e]))}))}return this.libraryPending}_getWorker(e){return this._initLibrary().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",libraryConfig:this.libraryConfig}),e.onmessage=t=>{var r=t.data;switch(r.type){case"warning":this.warnings.push(r.data);break;case"decode":e._callbacks[r.id].resolve(r);break;case"error":e._callbacks[r.id].reject(r)}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}}}]);